<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="References" href="../references.html" /><link rel="prev" title="Step 3: Marker Detection" href="step3_marker_detection.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.01.29 -->
        <title>Step 4: Prune Tree - scAtlas 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/override.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #003262;
  --color-brand-content: #003262;
  --admonition-font-size: var(--font-size-normal);
  --admonition-title-font-size: var(--font-size-normal);
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">scAtlas 0.0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/tooth_log.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/tooth_log.png" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction/introduction.html">Introduction to scAtlas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../preprocess/index.html">Preprocess</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Preprocess</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/metadata_process.html">Metadata Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/first_round_preprocess.html">First round preprocess</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/droplet.html">Droplet discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/first_round_annotation.html">First round annotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/post_annotation.html">Post annotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/batch_division.html">Batch division</a></li>
<li class="toctree-l2"><a class="reference internal" href="../preprocess/normalization.html">Normalization</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../pre-integration/index.html">Pre-integration</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Pre-integration</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../pre-integration/scib-benchmark.html">Integration methods benchmarking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pre-integration/hypertune.html">Hyperparameter tuning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integration/20241024_coarse_label.html">First-level annotation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Annotation</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Annotation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="20241025_mes_cluster.html">Step 0 : Leiden Clustering in Mesenchyme</a></li>
<li class="toctree-l2"><a class="reference internal" href="step1_choose_optimal_cluster_level.html">Step 1: Choose the optimal cluster levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="step2_mtree.html">Step 2: MRTree</a></li>
<li class="toctree-l2"><a class="reference internal" href="step3_marker_detection.html">Step 3: Marker Detection</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Step 4: Prune Tree</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/team.html">Team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/cite.html">Citing scAtlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing Guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="step-4-prune-tree">
<h1>Step 4: Prune Tree<a class="headerlink" href="#step-4-prune-tree" title="Permalink to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This step involves pruning the hierarchical clustering tree generated by MRTree in previous steps. The pruning process aims to refine the cluster structure by merging small or poorly differentiated clusters based on marker gene expression and cell counts. This helps to create a more robust and biologically meaningful cluster hierarchy.</p>
</section>
<section id="input">
<h2>Input<a class="headerlink" href="#input" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">20241025_mes_cluster_object.Rds</span></code>: The MRTree clustering results from <a class="reference internal" href="step2_mtree.html"><span class="std std-doc">Step 2</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">20241024_mesenchyme.Rds</span></code>: The Seurat object containing integrated mesenchymal cell data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mesenchyme_parameter.json</span></code>: Configuration file with parameters for tree pruning.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">annotation_mid_file/[new_name_suffix]_[start_node]_markers_siblings_[marker_suffix].tsv</span></code>: Marker genes identified by comparing sibling clusters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">annotation_mid_file/[new_name_suffix]_[start_node]_markers_all_[marker_suffix].tsv</span></code>: Marker genes identified by comparing each cluster to all other clusters.</p></li>
</ul>
</section>
<section id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">[new_name_suffix]_pruned_mrtree_clustering_results.rds</span></code>: A list containing the pruned clustering results, including updated labelmat, edgelist, nodelist, and data tree structure.</p></li>
</ul>
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1">## Script</span>

<span class="c1">##########</span>
<span class="c1">### Load parameters and packages</span>
<span class="c1">##########</span>

<span class="c1"># Clear the workspace</span>
<span class="nf">rm</span><span class="p">(</span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ls</span><span class="p">())</span>

<span class="c1"># Load utility functions</span>
<span class="nf">source</span><span class="p">(</span><span class="s">&quot;script/utils/anno_integrate.R&quot;</span><span class="p">)</span>
<span class="nf">message</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span><span class="s">&quot;: Starting mrtree pruning ..&quot;</span><span class="w"> </span><span class="p">)</span>

<span class="c1"># Load required packages</span>
<span class="nf">require</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="nf">require</span><span class="p">(</span><span class="n">Seurat</span><span class="p">)</span>
<span class="nf">require</span><span class="p">(</span><span class="n">Matrix</span><span class="p">)</span>

<span class="c1"># Define the directory for processed data</span>
<span class="n">processed_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;process/annotation/mes_annotation/&quot;</span>

<span class="c1"># Load the MRTree clustering results</span>
<span class="n">mrtree_result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">readRDS</span><span class="p">(</span><span class="s">&quot;process/annotation/mes_annotation/annotation_mid_file/20241025_mes_cluster_object.Rds&quot;</span><span class="p">)</span>

<span class="c1"># Load JSON parameters</span>
<span class="nf">source</span><span class="p">(</span><span class="s">&quot;script/utils/anno_utils.R&quot;</span><span class="p">)</span>
<span class="nf">load_json</span><span class="p">(</span><span class="s">&quot;script/annotation/config/mesenchyme_parameter.json&quot;</span><span class="p">)</span>

<span class="c1"># Load the Seurat object containing integrated mesenchymal cell data</span>
<span class="n">full_seurat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">readRDS</span><span class="p">(</span><span class="s">&quot;processed_data/integrated_data/20241024_mesenchyme.Rds&quot;</span><span class="p">)</span>

<span class="c1"># Load marker genes identified by comparing sibling clusters</span>
<span class="n">markers_comparisons_siblings</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">read.table</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">harmonization_folder_path</span><span class="p">,</span><span class="s">&quot;annotation_mid_file/&quot;</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">new_name_suffix</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">start_node</span><span class="p">,</span><span class="s">&quot;_markers_siblings_&quot;</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">marker_suffix</span><span class="p">,</span><span class="s">&quot;.tsv&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s">&quot;\t&quot;</span><span class="p">,</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">T</span><span class="p">)</span>

<span class="c1"># Load marker genes identified by comparing each cluster to all other clusters</span>
<span class="n">markers_comparisons_all</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="nf">read.table</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">harmonization_folder_path</span><span class="p">,</span><span class="s">&quot;annotation_mid_file/&quot;</span><span class="p">,</span>
<span class="w">                                              </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">new_name_suffix</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">,</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">start_node</span><span class="p">,</span>
<span class="w">                                              </span><span class="s">&quot;_markers_all_&quot;</span><span class="p">,</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">marker_suffix</span><span class="p">,</span><span class="s">&quot;.tsv&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s">&quot;\t&quot;</span><span class="p">,</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">T</span><span class="p">)</span>

<span class="c1">##########</span>
<span class="c1">### Further clean up marker genes to remove batch expressed genes</span>
<span class="c1">##########</span>

<span class="nf">if</span><span class="p">(</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">run_additional_gene_removal</span><span class="p">){</span>
<span class="w">  </span><span class="c1"># Extract gene expression data</span>
<span class="w">  </span><span class="n">gene_expr_dataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full_seurat</span><span class="o">@</span><span class="n">assays</span><span class="p">[[</span><span class="n">assay_markers</span><span class="p">]]</span><span class="o">@</span><span class="n">data</span>
<span class="w">  </span><span class="n">max_cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">30000</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Sample cells if the dataset is too large</span>
<span class="w">  </span><span class="nf">if</span><span class="p">(</span><span class="nf">ncol</span><span class="p">(</span><span class="n">gene_expr_dataset</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_cells</span><span class="p">){</span>
<span class="w">    </span><span class="nf">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span>
<span class="w">    </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">gene_expr_dataset</span><span class="p">),</span><span class="n">max_cells</span><span class="p">)</span>
<span class="w">    </span><span class="n">gene_expr_dataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gene_expr_dataset</span><span class="p">[,</span><span class="n">idx</span><span class="p">]</span>
<span class="w">    </span><span class="n">dataset_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="o">$</span><span class="n">Project</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">dataset_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="o">$</span><span class="n">Project</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Binarize gene expression data</span>
<span class="w">  </span><span class="n">gene_expr_dataset</span><span class="p">[</span><span class="n">gene_expr_dataset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="n">gene_expr_dataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">gene_expr_dataset</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Calculate per dataset occurrence</span>
<span class="w">  </span><span class="n">per_dataset_occ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">rowsum</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">gene_expr_dataset</span><span class="p">),</span><span class="n">dataset_factor</span><span class="p">)))</span>
<span class="w">  </span><span class="n">per_dataset_occ2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">apply</span><span class="p">(</span><span class="n">per_dataset_occ</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="nf">return</span><span class="p">(</span><span class="nf">round</span><span class="p">((</span><span class="n">x</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="m">5</span><span class="p">))})))</span>
<span class="w">  </span><span class="n">per_dataset_occ2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">per_dataset_occ2</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">x</span><span class="p">[</span><span class="nf">is.nan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">;</span><span class="w"> </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)})</span>

<span class="w">  </span><span class="c1"># Filter genes that are not occurring in at least 5 datasets</span>
<span class="w">  </span><span class="n">thresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.000001</span>
<span class="w">  </span><span class="n">per_dataset_occ_binary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">per_dataset_occ2</span><span class="p">)</span>
<span class="w">  </span><span class="n">per_dataset_occ_binary</span><span class="p">[</span><span class="n">per_dataset_occ_binary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">thresh</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="n">per_dataset_occ_binary</span><span class="p">[</span><span class="n">per_dataset_occ_binary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="w">  </span><span class="c1"># Calculate entropy</span>
<span class="w">  </span><span class="n">per_dataset_occ_entropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">per_dataset_occ2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">entropy_fun</span><span class="p">)</span>
<span class="w">  </span><span class="n">per_dataset_occ_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">occ</span><span class="o">=</span><span class="nf">rowSums</span><span class="p">(</span><span class="n">per_dataset_occ_binary</span><span class="p">),</span><span class="n">entropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_dataset_occ_entropy</span><span class="p">,</span><span class="n">gene</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rownames</span><span class="p">(</span><span class="n">per_dataset_occ_binary</span><span class="p">))</span>

<span class="w">  </span><span class="c1"># Exclude genes based on occurrence and entropy</span>
<span class="w">  </span><span class="n">balance_exclude_genes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_dataset_occ_min</span><span class="o">$</span><span class="n">gene</span><span class="p">[</span><span class="n">per_dataset_occ_min</span><span class="o">$</span><span class="n">occ</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">per_dataset_occ_min</span><span class="o">$</span><span class="n">entropy</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="m">1.25</span><span class="w"> </span><span class="p">]</span>
<span class="w">  </span><span class="nf">message</span><span class="p">(</span><span class="s">&quot;Excluding additional: &quot;</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">balance_exclude_genes</span><span class="p">),</span><span class="s">&quot; genes&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Update marker comparisons by removing excluded genes</span>
<span class="w">  </span><span class="n">markers_comparisons_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">markers_comparisons_all</span><span class="p">[</span><span class="o">!</span><span class="n">markers_comparisons_all</span><span class="o">$</span><span class="n">gene</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">balance_exclude_genes</span><span class="p">,]</span>
<span class="w">  </span><span class="n">markers_comparisons_siblings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">markers_comparisons_siblings</span><span class="p">[</span><span class="o">!</span><span class="n">markers_comparisons_siblings</span><span class="o">$</span><span class="n">gene</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">balance_exclude_genes</span><span class="p">,]</span>

<span class="w">  </span><span class="c1"># Save the list of excluded genes</span>
<span class="w">  </span><span class="nf">writeList_to_JSON</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">exlude_genes_pruning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance_exclude_genes</span><span class="p">),</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">harmonization_folder_path</span><span class="p">,</span><span class="s">&quot;annotation_mid_file/&quot;</span><span class="p">,</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">new_name_suffix</span><span class="p">,</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">marker_suffix</span><span class="p">,</span><span class="s">&quot;_additionally_removed_markers.json&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">##########</span>
<span class="c1">### Prepare raw edgelists</span>
<span class="c1">##########</span>

<span class="c1"># Extract key objects from the MRTree result</span>
<span class="n">edgelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mrtree_result</span><span class="o">$</span><span class="n">edgelist</span>
<span class="n">labelmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mrtree_result</span><span class="o">$</span><span class="n">labelmat</span>

<span class="c1"># Add label matrix to Seurat metadata</span>
<span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cbind</span><span class="p">(</span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="p">,</span><span class="n">labelmat</span><span class="p">)</span>

<span class="c1">##########</span>
<span class="c1">### Run mrtree pruning based on markers</span>
<span class="c1">##########</span>

<span class="nf">message</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span><span class="s">&quot;: Prune clusters ..&quot;</span><span class="w"> </span><span class="p">)</span>

<span class="c1"># Initialize edgelist and all_nodes</span>
<span class="n">edgelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="p">,</span><span class="s">&quot;to&quot;</span><span class="p">,</span><span class="s">&quot;level&quot;</span><span class="p">)]</span>
<span class="n">cluster_levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">labelmat</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">tidyr</span><span class="o">::</span><span class="nf">pivot_longer</span><span class="p">(</span><span class="nf">everything</span><span class="p">(),</span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;clusterlevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">values_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;cluster&quot;</span><span class="p">)</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">add_count</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;ncells&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">distinct</span><span class="p">(</span><span class="n">clusterlevel</span><span class="p">,</span><span class="n">cluster</span><span class="p">,</span><span class="n">ncells</span><span class="p">)</span>
<span class="n">edgelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">left_join</span><span class="p">(</span><span class="n">edgelist</span><span class="p">,</span><span class="n">cluster_levels</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="o">=</span><span class="s">&quot;cluster&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
<span class="n">all_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unique</span><span class="p">(</span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="p">)</span>

<span class="c1"># Remove columns from Seurat metadata that start with &quot;C&quot;</span>
<span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="p">[,</span><span class="w"> </span><span class="o">!</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;^C&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="p">))]</span>

<span class="c1"># Iterate over all nodes to perform pruning</span>
<span class="n">merge_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)){</span>
<span class="w">  </span><span class="n">current_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_nodes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
<span class="w">  </span><span class="n">parent_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">from</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">]</span>
<span class="w">  </span><span class="n">sibling_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">from</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">parent_node</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current_node</span><span class="p">]</span>
<span class="w">  </span><span class="n">current_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">clusterlevel</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">]</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Skip nodes below the minimum prune level</span>
<span class="w">  </span><span class="nf">if</span><span class="p">(</span><span class="n">edgelist</span><span class="o">$</span><span class="n">level</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_prune_level</span><span class="p">){</span><span class="n">next</span><span class="p">}</span>

<span class="w">  </span><span class="c1"># Filter siblings by cell count</span>
<span class="w">  </span><span class="n">sibling_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sibling_nodes</span><span class="p">[</span><span class="n">sibling_nodes</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">ncells</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_cells</span><span class="p">]]</span>
<span class="w">  </span><span class="nf">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">sibling_nodes</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">){</span><span class="n">next</span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Get cell count of the current node</span>
<span class="w">  </span><span class="n">ncells_current_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">ncells</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">]</span>

<span class="w">  </span><span class="c1"># Get number of sibling markers</span>
<span class="w">  </span><span class="n">sibling_markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">markers_comparisons_siblings</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">cluster_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">specificity</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">p_val_adj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">max_pvalue_prune</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">specificity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_specificity</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Get global markers</span>
<span class="w">  </span><span class="n">global_markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">markers_comparisons_all</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">cluster_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">specificity</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">p_val_adj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">max_pvalue_prune</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">specificity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_specificity</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Get parent global markers</span>
<span class="w">  </span><span class="n">parent_global_markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">markers_comparisons_all</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">cluster_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">parent_node</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">specificity</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">p_val_adj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">max_pvalue_prune</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">specificity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_specificity</span><span class="p">)</span>

<span class="w">  </span><span class="c1"># Check if the number of sibling markers or cell count is below the threshold</span>
<span class="w">  </span><span class="nf">if</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">sibling_markers</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_sibling_markers</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ncells_current_node</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">min_cells</span><span class="p">){</span>
<span class="w">    </span><span class="nf">if</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">parent_global_markers</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">3</span><span class="p">){</span>
<span class="w">      </span><span class="c1"># Get the expression of the parent markers in the current cluster</span>
<span class="w">      </span><span class="n">current_gene_expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">FetchData</span><span class="p">(</span><span class="n">full_seurat</span><span class="p">,</span><span class="n">vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_global_markers</span><span class="o">$</span><span class="n">gene</span><span class="p">,</span><span class="n">cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="o">$</span><span class="n">Cell_ID</span><span class="p">[</span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="p">[,</span><span class="n">current_level</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">current_node</span><span class="p">])</span>
<span class="w">      </span><span class="n">current_gene_expression_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">colMeans</span><span class="p">(</span><span class="n">current_gene_expression</span><span class="p">)</span>

<span class="w">      </span><span class="c1"># Iterate over all sibling markers to find the best merge candidate</span>
<span class="w">      </span><span class="n">intersection_lengths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span>
<span class="w">      </span><span class="n">coexpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span>
<span class="w">      </span><span class="nf">for</span><span class="p">(</span><span class="n">sib</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">sibling_nodes</span><span class="p">){</span>
<span class="w">        </span><span class="n">sibling_gene_expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">FetchData</span><span class="p">(</span><span class="n">full_seurat</span><span class="p">,</span><span class="n">vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent_global_markers</span><span class="o">$</span><span class="n">gene</span><span class="p">,</span><span class="n">cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="o">$</span><span class="n">Cell_ID</span><span class="p">[</span><span class="n">full_seurat</span><span class="o">@</span><span class="n">meta.data</span><span class="p">[,</span><span class="n">current_level</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sib</span><span class="p">])</span>
<span class="w">        </span><span class="n">sibling_gene_expression_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">colMeans</span><span class="p">(</span><span class="n">sibling_gene_expression</span><span class="p">)</span>
<span class="w">        </span><span class="n">coexpr</span><span class="p">[</span><span class="n">sib</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cor</span><span class="p">(</span><span class="n">current_gene_expression_mean</span><span class="p">,</span><span class="n">sibling_gene_expression_mean</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1"># Select the node with the highest correlation for merging</span>
<span class="w">      </span><span class="n">merge_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">coexpr</span><span class="p">)[</span><span class="n">coexpr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">coexpr</span><span class="p">)]</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">merge_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sibling_nodes</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="c1"># Fallback to the first sibling node</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nf">message</span><span class="p">(</span><span class="s">&quot;Merging node &quot;</span><span class="p">,</span><span class="n">current_node</span><span class="p">,</span><span class="s">&quot; (&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">),</span><span class="s">&quot;) into node(s) &quot;</span><span class="p">,</span><span class="nf">paste0</span><span class="p">(</span><span class="n">merge_nodes</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&quot;, &quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">all_nodes_to_merge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">merge_nodes</span><span class="p">,</span><span class="n">current_node</span><span class="p">)</span>
<span class="w">    </span><span class="n">merge_list</span><span class="p">[[</span><span class="nf">paste0</span><span class="p">(</span><span class="n">all_nodes_to_merge</span><span class="p">,</span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;_&quot;</span><span class="p">)]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_nodes_to_merge</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">##########</span>
<span class="c1">### Create pruned edgelist</span>
<span class="c1">##########</span>

<span class="nf">message</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span><span class="s">&quot;: Update labels and save ..&quot;</span><span class="w"> </span><span class="p">)</span>

<span class="c1"># Initialize updated edgelist and labelmat</span>
<span class="n">edgelist_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span>
<span class="n">labelmat_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelmat</span>
<span class="n">merge_list2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge_list</span>

<span class="c1"># Update edgelist and labelmat based on merge_list</span>
<span class="nf">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">merge_list2</span><span class="p">)){</span>
<span class="w">  </span><span class="n">nodes_to_merge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge_list2</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="n">nodes_to_merge</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Only update if there are truly 2 unique labels remaining</span>
<span class="w">  </span><span class="nf">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">nodes_to_merge</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">){</span>
<span class="w">    </span><span class="n">merge_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="nf">sort</span><span class="p">((</span><span class="n">nodes_to_merge</span><span class="p">))[</span><span class="m">1</span><span class="p">])</span>
<span class="w">    </span><span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot; &gt;&gt; merge to &quot;</span><span class="p">,</span><span class="n">merge_node</span><span class="p">))</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Update edgelist</span>
<span class="w">    </span><span class="n">edgelist_updated</span><span class="o">$</span><span class="n">from</span><span class="p">[</span><span class="n">edgelist_updated</span><span class="o">$</span><span class="n">from</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">nodes_to_merge</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge_node</span>
<span class="w">    </span><span class="n">edgelist_updated</span><span class="o">$</span><span class="n">to</span><span class="p">[</span><span class="n">edgelist_updated</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">nodes_to_merge</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge_node</span>
<span class="w">    </span><span class="n">edgelist_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist_updated</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">distinct</span><span class="p">(</span><span class="n">from</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">clusterlevel</span><span class="p">)</span><span class="w"> </span><span class="c1"># Merge duplicate rows to one entry and update the cell total</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Update labelmat</span>
<span class="w">    </span><span class="n">current_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist</span><span class="o">$</span><span class="n">clusterlevel</span><span class="p">[</span><span class="n">edgelist</span><span class="o">$</span><span class="n">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">merge_node</span><span class="p">]</span>
<span class="w">    </span><span class="n">labelmat_updated</span><span class="p">[</span><span class="n">labelmat_updated</span><span class="p">[,</span><span class="n">current_level</span><span class="p">]</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">nodes_to_merge</span><span class="p">,</span><span class="n">current_level</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge_node</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Change all occurrences in merge_list</span>
<span class="w">    </span><span class="n">merge_list2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">lapply</span><span class="p">(</span><span class="n">merge_list2</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">remove_nodes</span><span class="p">,</span><span class="n">new_node</span><span class="p">){</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">remove_nodes</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_node</span><span class="p">;</span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)},</span><span class="n">remove_nodes</span><span class="o">=</span><span class="n">nodes_to_merge</span><span class="p">,</span><span class="n">new_node</span><span class="o">=</span><span class="n">merge_node</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">##########</span>
<span class="c1">### Update labels in edgelist and labelmat</span>
<span class="c1">##########</span>

<span class="c1"># Define old and new prefixes for cluster levels</span>
<span class="n">old_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">old_prefix</span><span class="w"> </span><span class="c1"># &quot;K&quot;</span>
<span class="n">new_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameter_list</span><span class="o">$</span><span class="n">new_prefix</span><span class="w"> </span><span class="c1"># &quot;C&quot;</span>

<span class="c1"># Update cluster levels in the edgelist</span>
<span class="n">all_cluster_levels_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist_updated</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">clusterlevel</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">count</span><span class="p">()</span>
<span class="n">all_cluster_levels_updated</span><span class="o">$</span><span class="n">clusterlevel_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">all_cluster_levels_updated</span><span class="o">$</span><span class="n">clusterlevel</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="nf">str_extract</span><span class="p">(</span><span class="n">old_prefix</span><span class="p">)</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="nf">str_replace</span><span class="p">(</span><span class="n">old_prefix</span><span class="p">,</span><span class="w"> </span><span class="n">new_prefix</span><span class="p">),</span><span class="n">all_cluster_levels_updated</span><span class="o">$</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Create new labels using the pruned numbers of labels per level</span>
<span class="n">all_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">all_cluster_levels_updated</span><span class="p">)){</span>
<span class="w">  </span><span class="n">edgelist_updated_current_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist_updated</span><span class="p">[</span><span class="n">edgelist_updated</span><span class="o">$</span><span class="n">clusterlevel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">all_cluster_levels_updated</span><span class="o">$</span><span class="n">clusterlevel</span><span class="p">[</span><span class="n">c</span><span class="p">],]</span>
<span class="w">  </span><span class="nf">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">edgelist_updated_current_level</span><span class="p">)){</span>
<span class="w">    </span><span class="n">new_node_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">old_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist_updated_current_level</span><span class="o">$</span><span class="n">to</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<span class="w">                                </span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">all_cluster_levels_updated</span><span class="o">$</span><span class="n">clusterlevel_new</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">),</span>
<span class="w">                                </span><span class="n">new_cluster_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all_cluster_levels_updated</span><span class="o">$</span><span class="n">clusterlevel_new</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
<span class="w">    </span><span class="n">all_rows</span><span class="p">[[</span><span class="n">new_node_label</span><span class="o">$</span><span class="n">new_node</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_node_label</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="n">new_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.data.frame</span><span class="p">(</span><span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span><span class="n">all_rows</span><span class="p">))</span>

<span class="c1"># Make new edgelist with updated labels</span>
<span class="n">edgelist_updated_new_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">left_join</span><span class="p">(</span><span class="n">edgelist_updated</span><span class="p">,</span><span class="n">new_labels</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;old_node&quot;</span><span class="p">,</span><span class="s">&quot;new_node&quot;</span><span class="p">)],</span><span class="n">by</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;from&quot;</span><span class="o">=</span><span class="s">&quot;old_node&quot;</span><span class="p">))</span>
<span class="n">edgelist_updated_new_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">left_join</span><span class="p">(</span><span class="n">edgelist_updated_new_labels</span><span class="p">,</span><span class="n">new_labels</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="o">=</span><span class="s">&quot;old_node&quot;</span><span class="p">))</span>
<span class="n">edgelist_updated_new_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edgelist_updated_new_labels</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_node.x</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_node.y</span><span class="p">,</span><span class="n">clusterlevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_cluster_level</span><span class="p">)</span>
<span class="n">edgelist_updated_new_labels</span><span class="o">$</span><span class="n">from</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">edgelist_updated_new_labels</span><span class="o">$</span><span class="n">from</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all&quot;</span>

<span class="c1"># Make new labelmat with updated labels</span>
<span class="n">labelmat_updated_new_labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">labelmat_updated</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">new_labels</span><span class="p">){</span>
<span class="w">  </span><span class="n">new_labels</span><span class="o">$</span><span class="n">new_node</span><span class="p">[</span><span class="nf">match</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">new_labels</span><span class="o">$</span><span class="n">old_node</span><span class="p">)]</span>
<span class="p">},</span><span class="n">new_labels</span><span class="o">=</span><span class="n">new_labels</span><span class="p">)</span>

<span class="c1"># Update column names of the new labelmat</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">labelmat_updated_new_labels</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="nf">str_extract</span><span class="p">(</span><span class="n">labelmat_updated_new_labels</span><span class="p">[</span><span class="m">1</span><span class="p">,],</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">new_prefix</span><span class="p">,</span><span class="s">&quot;[0-9]+&quot;</span><span class="p">))</span>

<span class="c1">##########</span>
<span class="c1">### Create pruned result version</span>
<span class="c1">##########</span>

<span class="c1"># Save the pruned result in data.tree format</span>
<span class="nf">require</span><span class="p">(</span><span class="n">data.tree</span><span class="p">)</span>
<span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.data.frame</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">labelmat_updated_new_labels</span><span class="p">),</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">F</span><span class="p">)</span>
<span class="n">df</span><span class="o">$</span><span class="n">pathString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">paste</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">collapse</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
<span class="n">tree.datatree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.tree</span><span class="o">::</span><span class="nf">as.Node</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Export the edgelist</span>
<span class="n">edges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.tree</span><span class="o">::</span><span class="nf">ToDataFrameNetwork</span><span class="p">(</span><span class="n">tree.datatree</span><span class="p">,</span><span class="s">&quot;isLeaf&quot;</span><span class="p">,</span><span class="s">&quot;level&quot;</span><span class="p">,</span><span class="s">&quot;count&quot;</span><span class="p">,</span><span class="s">&quot;totalCount&quot;</span><span class="p">,</span><span class="s">&quot;height&quot;</span><span class="p">)</span>
<span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="nf">as.character</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">edges</span><span class="o">$</span><span class="n">to</span><span class="p">))),</span><span class="n">label</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="nf">as.character</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">edges</span><span class="o">$</span><span class="n">to</span><span class="p">))))</span>
<span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rbind</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;all&quot;</span><span class="p">,</span><span class="kc">FALSE</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">208</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">edges</span><span class="o">$</span><span class="n">height</span><span class="p">)</span><span class="m">+1</span><span class="p">),</span><span class="n">edges</span><span class="p">[,</span><span class="m">2</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">edges</span><span class="p">)])</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">rename</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>

<span class="c1"># Create the updated cluster object and add to misc</span>
<span class="n">updated_cluster_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">labelmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelmat_updated_new_labels</span><span class="p">,</span>
<span class="w">                              </span><span class="n">edgelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">edges</span><span class="p">,</span>
<span class="w">                              </span><span class="n">nodelist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nodes</span><span class="p">,</span>
<span class="w">                              </span><span class="n">data_tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree.datatree</span><span class="p">)</span>

<span class="c1">##########</span>
<span class="c1">### Save</span>
<span class="c1">##########</span>

<span class="c1"># Save the updated cluster object</span>
<span class="nf">saveRDS</span><span class="p">(</span><span class="n">updated_cluster_object</span><span class="p">,</span><span class="nf">paste0</span><span class="p">(</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">harmonization_folder_path</span><span class="p">,</span><span class="s">&quot;annotation_mid_file/&quot;</span><span class="p">,</span><span class="n">parameter_list</span><span class="o">$</span><span class="n">new_name_suffix</span><span class="p">,</span><span class="s">&quot;_pruned_mrtree_clustering_results&quot;</span><span class="p">,</span><span class="s">&quot;.rds&quot;</span><span class="p">))</span>

<span class="nf">message</span><span class="p">(</span><span class="s">&quot;Finalized pruning&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../references.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">References</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="step3_marker_detection.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Step 3: Marker Detection</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Gilbert Han
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link fab fa-github" href="https://github.com/GilbertHan1011/toothAtlasManuscript" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Step 4: Prune Tree</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#input">Input</a></li>
<li><a class="reference internal" href="#output">Output</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=f6245a2f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script defer="defer" src="https://unpkg.com/@popperjs/core@2"></script>
    <script defer="defer" src="https://unpkg.com/tippy.js@6"></script>
    <script defer="defer" src="../_static/tippy/annotation/step4_prune_tree.34332fab-5bc2-40b0-bf77-4170c6cd7ed7.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>