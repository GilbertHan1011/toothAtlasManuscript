# Step 3: Marker Detection

## Introduction
In this step, we perform marker detection to identify genes that are differentially expressed between different cell clusters. We use a tree-based approach to detect markers at different levels of the hierarchical clustering tree generated by MRTree in the previous step. This allows us to identify both broad markers that distinguish major cell types and more specific markers that differentiate closely related subtypes.

## Input
- `20241025_mes_cluster_object.Rds`: The cluster object containing the MRTree results from [Step 2](./step2_mtree.md).
- `20241024_mesenchyme.Rds`: The Seurat object containing the integrated mesenchymal cell data.
- `mesenchyme_parameter.json`: Configuration file with parameters for marker detection.

## Output
- `20241026_anno_marker.rds`: A list containing the results of marker detection, including comparisons between sibling clusters and all clusters.
- `[new_name_suffix]_[start_node]_markers_siblings_[marker_suffix].tsv`: Tab-separated file containing marker genes identified by comparing sibling clusters.
- `[new_name_suffix]_[start_node]_markers_all_[marker_suffix].tsv`: Tab-separated file containing marker genes identified by comparing each cluster to all other clusters.

## Script
```R
##########
### Load parameters and packages
##########
rm(list = ls())
message(Sys.time(), ": Starting fast marker detection...")

message("Loading parameters and packages")

library(tidyverse)
library(Seurat)
library(Matrix)

source("script/utils/stratified_wilcoxon_functions.R")
source("script/utils/anno_integrate.R")

processed_dir <- "process/annotation/mes_annotation/"

source("script/utils/anno_utils.R")
load_json("script/annotation/config/mesenchyme_parameter.json")

cluster_object <- readRDS("process/annotation/mes_annotation/annotation_mid_file/20241025_mes_cluster_object.Rds")
full_seurat <- readRDS("processed_data/integrated_data/20241024_mesenchyme.Rds")

# Load MRTree clustering result
mrtree_result <- cluster_object
start_node <- parameter_list$start_node %||% "all"

additional_suffix <- parameter_list$additional_suffix %||% ""
base <- parameter_list$base %||% 2
add_batch_as_latent <- parameter_list$add_batch_as_latent %||% FALSE

if (!parameter_list$test.use %in% c('negbinom', 'poisson', 'MAST', "LR")) {
  add_batch_as_latent <- FALSE
}

message("additional_suffix: ", additional_suffix)
message("add_batch_as_latent: ", add_batch_as_latent)

##########
### Prepare edgelist and labelmat
##########

edgelist <- mrtree_result$edgelist[, 1:2]
message("Loaded edgelist with ", nrow(edgelist), " rows.")
labelmat <- mrtree_result$labelmat
message("Loaded labelmat with ", nrow(labelmat), " rows.")

message("Object cells: ", ncol(full_seurat), "  Labelmat cells: ", nrow(labelmat))

# Find subtree and subset edgelist if start node is specified
all_children <- find_children(nodes = start_node, edges = edgelist[, 1:2])
if (length(all_children) < 3) {
  message("Cannot find enough children for starting node ", start_node, ". Using all nodes in tree instead")
  all_children <- unique(edgelist[, 2])
}

edgelist <- edgelist[edgelist$to %in% all_children, ]

# Determine cells to include when downsampling for feature abundance check
cells_to_check <- if (start_node != "all") {
  rownames(full_seurat@meta.data)[labelmat[, which(apply(labelmat, 2, function(x, target) target %in% x, target = start_node))] == start_node]
} else {
  rownames(full_seurat@meta.data)
}

##########
### Calculate markers between leaf-siblings and merge
##########

# Subset features to be tested
if (ncol(full_seurat@assays[["originalexp"]]@data) > 30000) {
  set.seed(parameter_list$global_seed)
  subset <- sample(colnames(full_seurat@assays[['originalexp']]@data[, cells_to_check]), size = 30000)
  gene_expr_dataset <- full_seurat@assays[['originalexp']]@data[, subset]
} else {
  gene_expr_dataset <- full_seurat@assays[['originalexp']]@data
}

gene_expr_dataset[gene_expr_dataset != 0] <- 1  # Set to 1 for occurrence
gene_sums <- Matrix::rowSums(gene_expr_dataset)
rm(gene_expr_dataset)
genes_to_include <- names(gene_sums)[gene_sums > parameter_list$min.cells.feature]
message("Testing ", length(genes_to_include), " genes as cluster markers")
write.csv(genes_to_include, "process/annotation/mes_annotation/annotation_mid_file/20241025_gene_include.csv")

latent_vars_seurat <- if (add_batch_as_latent) {
  message("Adding batch_var: ", parameter_list$batch_var, " as latent var to Seurat based test.")
  parameter_list$batch_var
} else {
  NULL
}

full_seurat@meta.data <- full_seurat@meta.data[, !grepl("^K", names(full_seurat@meta.data))]

# Run marker detection on tree using findMarkers_tree2
message(Sys.time(), ": Start marker detection on MRTree")
all_markers_mrtree_list <- findMarkers_tree2(
  full_seurat,
  edgelist = edgelist[, 1:2],
  labelmat = labelmat,
  n_cores = 4,
  assay = parameter_list$assay_markers,
  slot = parameter_list$assay_slot,
  test.use = parameter_list$test.use,
  batch_var = parameter_list$batch_var,
  latent_vars_seurat = latent_vars_seurat,
  genes_to_include = genes_to_include,
  logfc.threshold = parameter_list$logfc.threshold,
  min.pct = parameter_list$min.pct,
  min.diff.pct = parameter_list$min.diff.pct,
  max.cells.per.ident = parameter_list$max.cells.per.ident,
  min.cells.feature = parameter_list$min.cells.feature,
  min.cells.group = parameter_list$min.cells.group,
  base = base,
  only.pos = parameter_list$only.pos
)

saveRDS(all_markers_mrtree_list, paste0(processed_dir, "20241026_anno_marker.rds"))

message("names(all_markers_mrtree_list): ", paste(names(all_markers_mrtree_list), collapse = ", "))

# Process and save results
comparisons_siblings <- as.data.frame(all_markers_mrtree_list$comparisons_Sibling)
comparisons_all <- as.data.frame(all_markers_mrtree_list$comparisons_All)

comparisons_siblings$specificity <- ((comparisons_siblings$pct.1 + parameter_list$specificity_base) / 
                                     (comparisons_siblings$pct.2 + parameter_list$specificity_base)) * 
                                    comparisons_siblings$avg_log2FC
comparisons_all$specificity <- ((comparisons_all$pct.1 + parameter_list$specificity_base) / 
                                (comparisons_all$pct.2 + parameter_list$specificity_base)) * 
                               comparisons_all$avg_log2FC

# Save results as TSV files
data.table::fwrite(comparisons_siblings, 
                   paste0(parameter_list$harmonization_folder_path, 
                          parameter_list$new_name_suffix, "_", 
                          parameter_list$start_node, "_markers_siblings_", 
                          parameter_list$marker_suffix, ".tsv"), 
                   sep = "\t")

data.table::fwrite(comparisons_all, 
                   paste0(parameter_list$harmonization_folder_path, 
                          parameter_list$new_name_suffix, "_", 
                          parameter_list$start_node, "_markers_all_", 
                          parameter_list$marker_suffix, ".tsv"), 
                   sep = "\t")

message(Sys.time(), ": Finalized marker detection.")

```
